# backup_folder.py

共有ドライブのフォルダを丸ごとコピーするスクリプト

## 概要

このスクリプトは、Google Driveの共有ドライブ内のフォルダを丸ごとコピーするためのツールです。

- `my_settings.json`で指定された基底フォルダを
- 引数で指定されたフォルダIDの直下に丸ごとコピー
- フォルダ構造を維持して再帰的にコピー
- タイムスタンプ付きのバックアップフォルダを作成
- **詳細な進捗状況の表示**

## 必要な環境

- Python 3.7以上
- Google Cloud Platform アカウント（Google Drive API使用）
- 既存の`my_secrets.json`ファイル（認証情報）

## セットアップ

### 1. 依存ライブラリのインストール

```bash
pip install google-api-python-client google-auth-oauthlib
```

### 2. 設定ファイルの準備

`my_settings.json`に`BASE_FOLDER_ID`を追加：

```json
{
  "SKIP_LATLONG_UPDATE_LIST": [
    ["福岡県", "福岡市"],
    ["千葉県", "習志野市"],
    ["兵庫県", "加西市"]
  ],
  "BASE_FOLDER_ID": "YOUR_BASE_FOLDER_ID_HERE"
}
```

**注意**: `YOUR_BASE_FOLDER_ID_HERE`を実際のフォルダIDに置き換えてください。

### 3. 認証情報の確認

既存の`my_secrets.json`ファイルが正しく設定されていることを確認してください。

## 使用方法

### 基本的な使い方

```bash
# 基本的なコピー（my_settings.jsonのBASE_FOLDER_IDを使用）
python backup_folder.py <コピー先フォルダID>

# 特定のフォルダをコピー元として指定
python backup_folder.py <コピー先フォルダID> --source-folder-id <コピー元フォルダID>

# ドライラン（実際のコピーは行わず、処理内容のみ表示）
python backup_folder.py <コピー先フォルダID> --dry-run
```

### オプション

- `target_folder_id`: コピー先のフォルダID（必須）
- `--dry-run`: 実際のコピーは行わず、処理内容のみ表示
- `--source-folder-id`: コピー元のフォルダID（指定しない場合はmy_settings.jsonから読み込み）

### 使用例

```bash
# 基本的なバックアップ
python backup_folder.py 1ABC123DEF456

# ドライランで処理内容を確認
python backup_folder.py 1ABC123DEF456 --dry-run

# 特定のフォルダをコピー元として指定
python backup_folder.py 1ABC123DEF456 --source-folder-id 2XYZ789GHI012

# ドライラン + 特定のフォルダ
python backup_folder.py 1ABC123DEF456 --source-folder-id 2XYZ789GHI012 --dry-run
```

## 出力例

### 通常実行時（進捗追跡付き）

```
2025-07-23 02:00:00,000 INFO === フォルダバックアップ開始 ===
2025-07-23 02:00:00,001 INFO コピー先フォルダID: 1ABC123DEF456
2025-07-23 02:00:00,002 INFO ドライラン: False
2025-07-23 02:00:00,003 INFO 認証情報を取得中...
2025-07-23 02:00:00,004 INFO コピー先フォルダの妥当性をチェック中...
2025-07-23 02:00:00,005 INFO コピー元フォルダID: 2XYZ789GHI012 (my_settings.jsonから読み込み)
2025-07-23 02:00:00,006 INFO コピー元フォルダの妥当性をチェック中...
2025-07-23 02:00:00,007 INFO コピー元フォルダ名: 自治体データ
2025-07-23 02:00:00,008 INFO === フォルダコピー開始 ===
2025-07-23 02:00:00,009 INFO 総アイテム数をカウント中...
2025-07-23 02:00:00,010 INFO 総アイテム数: 150
2025-07-23 02:00:00,011 INFO === 進捗追跡開始 ===
2025-07-23 02:00:00,012 INFO 総アイテム数: 150
2025-07-23 02:00:00,013 INFO バックアップフォルダ名: 自治体データ_backup_20250723_020000
2025-07-23 02:00:00,014 INFO フォルダ処理開始: 自治体データ_backup_20250723_020000
2025-07-23 02:00:00,015 INFO フォルダ作成完了: 自治体データ_backup_20250723_020000 (ID: 3DEF456JKL789)
2025-07-23 02:00:00,016 INFO 進捗: 1/150 (0.7%) - フォルダ: 1, ファイル: 0 - 速度: 10.0 アイテム/秒 - 残り時間: 0:00:14
2025-07-23 02:00:00,017 INFO コピー完了: 東京都.csv -> 東京都.csv (ID: 4GHI789MNO012)
2025-07-23 02:00:00,018 INFO 進捗: 2/150 (1.3%) - フォルダ: 1, ファイル: 1 - 速度: 8.5 アイテム/秒 - 残り時間: 0:00:17
2025-07-23 02:00:00,019 INFO フォルダ処理開始: サブフォルダ
2025-07-23 02:00:00,020 INFO フォルダ作成完了: サブフォルダ (ID: 5JKL012PQR345)
2025-07-23 02:00:00,021 INFO 進捗: 3/150 (2.0%) - フォルダ: 2, ファイル: 1 - 速度: 7.2 アイテム/秒 - 残り時間: 0:00:20
...
2025-07-23 02:00:15,000 INFO 進捗: 150/150 (100.0%) - フォルダ: 25, ファイル: 125 - 速度: 10.0 アイテム/秒 - 残り時間: 0:00:00
2025-07-23 02:00:15,001 INFO === 進捗追跡完了 ===
2025-07-23 02:00:15,002 INFO 総処理時間: 0:00:15
2025-07-23 02:00:15,003 INFO 総処理アイテム数: 150
2025-07-23 02:00:15,004 INFO フォルダ数: 25, ファイル数: 125
2025-07-23 02:00:15,005 INFO === フォルダバックアップ完了 ===
2025-07-23 02:00:15,006 INFO バックアップフォルダID: 3DEF456JKL789
2025-07-23 02:00:15,007 INFO バックアップフォルダ名: 自治体データ_backup_20250723_020000
```

### ドライラン時

```
2025-07-23 02:00:00,000 INFO === フォルダバックアップ開始 ===
2025-07-23 02:00:00,001 INFO コピー先フォルダID: 1ABC123DEF456
2025-07-23 02:00:00,002 INFO ドライラン: True
2025-07-23 02:00:00,003 INFO 認証情報を取得中...
2025-07-23 02:00:00,004 INFO コピー先フォルダの妥当性をチェック中...
2025-07-23 02:00:00,005 INFO コピー元フォルダID: 2XYZ789GHI012 (my_settings.jsonから読み込み)
2025-07-23 02:00:00,006 INFO コピー元フォルダの妥当性をチェック中...
2025-07-23 02:00:00,007 INFO コピー元フォルダ名: 自治体データ
2025-07-23 02:00:00,008 INFO === ドライラン: 処理内容 ===
2025-07-23 02:00:00,009 INFO コピー元: 自治体データ (ID: 2XYZ789GHI012)
2025-07-23 02:00:00,010 INFO コピー先: 1ABC123DEF456
2025-07-23 02:00:00,011 INFO コピー対象アイテム数: 3
2025-07-23 02:00:00,012 INFO   - 東京都.csv (ファイル)
2025-07-23 02:00:00,013 INFO   - サブフォルダ (フォルダ)
2025-07-23 02:00:00,014 INFO   - データファイル.txt (ファイル)
2025-07-23 02:00:00,015 INFO ドライラン完了
```

## 機能詳細

### 1. フォルダ構造の維持

- 元のフォルダ構造を完全に保持
- サブフォルダも再帰的にコピー
- ファイル名は変更せずにコピー

### 2. タイムスタンプ付きバックアップ

- バックアップフォルダ名にタイムスタンプを追加
- 形式: `{元フォルダ名}_backup_{YYYYMMDD_HHMMSS}`
- 例: `自治体データ_backup_20250723_020000`

### 3. 詳細な進捗追跡機能

- **総アイテム数の事前カウント**: 処理開始前に総アイテム数を再帰的にカウント
- **リアルタイム進捗表示**: 処理済みアイテム数/総アイテム数とパーセンテージ
- **処理速度の表示**: アイテム/秒での処理速度
- **残り時間の推定**: 現在の速度に基づく残り時間の計算
- **アイテム種別のカウント**: フォルダ数とファイル数の個別カウント
- **処理時間の記録**: 総処理時間の記録と表示

#### 進捗表示の例
```
進捗: 45/150 (30.0%) - フォルダ: 8, ファイル: 37 - 速度: 9.2 アイテム/秒 - 残り時間: 0:00:11
```

### 4. エラーハンドリング

- フォルダIDの妥当性チェック
- API呼び出しエラーの適切な処理
- 個別ファイルのコピー失敗時も処理を継続

### 5. API制限対策

- ファイルコピー間に0.1秒の待機時間
- ページネーション対応
- 共有ドライブ対応

## ログ出力

実行結果は以下に出力されます：
- コンソール（標準出力）
- `backup_folder.log`ファイル

## テスト

```bash
# 全テストを実行
python test_backup_folder.py

# 詳細出力でテスト実行
python test_backup_folder.py -v
```

### テスト内容

- **ProgressTrackerクラス**: 進捗追跡機能のテスト
- **基本機能**: ファイル・フォルダ操作のテスト
- **エラーハンドリング**: 各種エラーケースのテスト
- **統合テスト**: 全体の動作確認

## 注意事項

1. **権限**: コピー元とコピー先のフォルダにアクセス権限が必要です
2. **API制限**: Google Drive APIの制限により、大量のファイルがある場合は時間がかかります
3. **ストレージ**: コピー先の共有ドライブに十分な容量があることを確認してください
4. **ドライラン**: 初回実行時は必ず`--dry-run`オプションで処理内容を確認してください
5. **進捗表示**: 大量のファイルがある場合、進捗表示により処理状況を詳細に把握できます

## トラブルシューティング

### よくあるエラー

1. **認証エラー**
   ```
   my_secrets.jsonファイルが見つかりません
   ```
   → `my_secrets.json`ファイルが正しい場所にあることを確認

2. **フォルダIDエラー**
   ```
   指定されたID xxx はフォルダではありません
   ```
   → 指定したIDが正しいフォルダIDであることを確認

3. **権限エラー**
   ```
   フォルダID検証エラー: 403 Forbidden
   ```
   → フォルダへのアクセス権限があることを確認

4. **進捗表示の遅延**
   ```
   進捗: 0/100 (0.0%) - 速度: 0.0 アイテム/秒 - 残り時間: 計算中...
   ```
   → 処理開始直後は正常な動作です。しばらく待つと正確な進捗が表示されます

## ライセンス

MIT License

## 作者

TeamMirai 