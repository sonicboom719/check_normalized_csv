# ss_folder_link.py - スプレッドシート-フォルダ連携スクリプト

## 概要

このスクリプトは、Googleスプレッドシートに記載された都道府県・市区町村の情報をもとに、Google Drive上の対応するフォルダを探索し、そのフォルダIDをスプレッドシートに書き込むPythonツールです。

## 主な機能

- **スプレッドシート読み込み**: A列（都道府県）とB列（市区町村）のデータを読み込み
- **フォルダ構造探索**: 基準フォルダ内の階層的なフォルダ構造を走査
- **複数パターン対応**: `{prefecture}/{city}`、`立候補者なし/{prefecture}/{city}`、`{prefecture}/立候補者なし/{city}` の3パターンに対応
- **自動書き込み**: 見つかったフォルダIDまたは「not found」を指定列に書き込み
- **詳細ログ出力**: 処理内容を詳細にログファイルとコンソールに出力
- **進捗表示**: `[13/999]` 形式で処理の進捗状況を表示

## 前提条件

### 必要なファイル

- `my_secrets.json`: Google API認証情報
- `token.json`: OAuth2トークン（自動生成）

### my_secrets.json の設定

```json
{
  "OAUTH2_CLIENT_INFO": {
    "installed": {
      "client_id": "your-client-id",
      "project_id": "your-project-id",
      "auth_uri": "https://accounts.google.com/o/oauth2/auth",
      "token_uri": "https://oauth2.googleapis.com/token",
      "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
      "client_secret": "your-client-secret",
      "redirect_uris": ["http://localhost"]
    }
  }
}
```

### 必要なPythonライブラリ

```bash
pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
```

### 必要な権限

- **Google Drive API**: 読み取り専用（`drive.readonly`）
- **Google Sheets API**: 読み書き（`spreadsheets`）

## 使用方法

### 基本的な実行

```bash
python ss_folder_link.py <基準フォルダID> <スプシID> <シートID> <列>
```

### パラメータ

1. **基準フォルダID**（必須）: Google Driveの基準フォルダID
2. **スプシID**（必須）: GoogleスプレッドシートのID
3. **シートID**（必須）: シートID（数値、シート名ではない）
4. **列**（必須）: 書き込み先の列（アルファベット、例: C, D, AA）

### スプレッドシートの形式

| A列（prefecture） | B列（city） | C列（書き込み先の例） |
|------------------|------------|---------------------|
| 都道府県名        | 市区町村名   | （ヘッダー）        |
| 東京都           | 渋谷区      | （フォルダID）      |
| 愛媛県           | 松山市      | （フォルダID）      |
| 神奈川県         | 大磯町      | not found           |

- **1行目**: ヘッダー行（スキップされます）
- **2行目以降**: データ行
- **A列**: 都道府県名（必須）
- **B列**: 市区町村名（必須）

### シートIDの確認方法

スプレッドシートのURLから確認：
```
https://docs.google.com/spreadsheets/d/{スプシID}/edit#gid={シートID}
                                                              ↑
                                                        この数値がシートID
```

## 使用例

### 例1: C列にフォルダIDを書き込み

```bash
python ss_folder_link.py 1yOsYgLdHmd0v6BvA8Guainsx_jC8enx8 1AbCdEfGhIjKlMnOpQrStUvWxYz123456 0 C
```

- 基準フォルダID: `1yOsYgLdHmd0v6BvA8Guainsx_jC8enx8`
- スプレッドシートID: `1AbCdEfGhIjKlMnOpQrStUvWxYz123456`
- シートID: `0`（最初のシート）
- 書き込み列: `C`

### 例2: AA列に書き込み

```bash
python ss_folder_link.py 1yOsYgLdHmd0v6BvA8Guainsx_jC8enx8 1AbCdEfGhIjKlMnOpQrStUvWxYz123456 123456789 AA
```

## 処理フロー

1. **認証**: Google API OAuth2認証
2. **スプレッドシート読み込み**: A列とB列のデータを取得（2行目以降）
3. **フォルダ構造探索**:
   - **第1階層**: 都道府県フォルダまたは「立候補者なし」フォルダ
   - **第2階層**: 市区町村フォルダまたは都道府県フォルダ（立候補者なしの場合）
   - **第3階層**: 市区町村フォルダ（立候補者なし/{prefecture}の場合）
4. **マッチング**: (prefecture, city)のペアでフォルダを検索
5. **書き込み**: 見つかったフォルダIDまたは「not found」を書き込み
6. **統計情報表示**: 総データ数、見つかった数、見つからなかった数を表示

## フォルダ構造

### 対応するフォルダ構造

```
基準フォルダ
├── 愛媛県/
│   ├── 松山市/  ← マッチング対象
│   ├── 今治市/  ← マッチング対象
│   └── 立候補者なし/
│       └── 久万高原町/  ← マッチング対象
├── 東京都/
│   └── 渋谷区/  ← マッチング対象
└── 立候補者なし/
    ├── 東京都/
    │   └── 小笠原村/  ← マッチング対象
    └── 鹿児島県/
        └── 十島村/  ← マッチング対象
```

### マッチングルール

| スプシの内容        | フォルダパス                         | 結果 |
|-------------------|-------------------------------------|------|
| 東京都, 渋谷区      | 東京都/渋谷区/                       | ✓    |
| 東京都, 小笠原村    | 立候補者なし/東京都/小笠原村/         | ✓    |
| 愛媛県, 久万高原町  | 愛媛県/立候補者なし/久万高原町/       | ✓    |
| 神奈川県, 存在しない | （存在しない）                       | not found |

## ログ出力

### ログファイル

- `ss_folder_link.log`: 処理の詳細ログ（UTF-8エンコーディング）

### ログレベル

- **INFO**: 通常の処理進捗
- **WARNING**: フォルダが見つからない場合、APIエラーからのリトライ
- **ERROR**: エラー発生時

### ログ出力例

```
2026-01-21 10:00:00 INFO === スプレッドシート-フォルダ連携開始 ===
2026-01-21 10:00:01 INFO 基準フォルダID: 1yOsYgLdHmd0v6BvA8Guainsx_jC8enx8
2026-01-21 10:00:02 INFO スプレッドシートID: 1AbCdEfGhIjKlMnOpQrStUvWxYz123456
2026-01-21 10:00:03 INFO シートID: 0
2026-01-21 10:00:04 INFO 書き込み列: C
2026-01-21 10:00:05 INFO 認証情報を取得中...
2026-01-21 10:00:06 INFO スプレッドシートを読み込み中...
2026-01-21 10:00:07 INFO スプレッドシート読み込み完了: 1500件のデータ
2026-01-21 10:00:08 INFO フォルダ構造を探索中...
2026-01-21 10:00:09 INFO 第1階層フォルダ数: 48
2026-01-21 10:00:10 INFO [1/48] 都道府県フォルダ: 愛媛県
2026-01-21 10:00:11 INFO   登録: 愛媛県/松山市 -> 1XyZ...
2026-01-21 10:00:12 INFO   登録: 愛媛県/今治市 -> 1AbC...
2026-01-21 10:00:13 INFO [48/48] 立候補者なしフォルダ: 立候補者なし
2026-01-21 10:00:14 INFO   登録: 東京都/小笠原村 -> 1Def...
2026-01-21 10:00:15 INFO フォルダマップ作成完了: 1500件
2026-01-21 10:00:16 INFO マッチング処理開始...
2026-01-21 10:00:17 INFO [1/1500] 愛媛県/松山市 -> 1XyZ...
2026-01-21 10:00:18 INFO [2/1500] 愛媛県/今治市 -> 1AbC...
2026-01-21 10:00:19 WARNING [3/1500] 神奈川県/存在しない -> not found
...
2026-01-21 10:05:00 INFO スプレッドシートに書き込み中...
2026-01-21 10:05:01 INFO スプレッドシート書き込み完了: 1500セルを更新
2026-01-21 10:05:02 INFO === 統計情報 ===
2026-01-21 10:05:03 INFO 総データ数: 1500
2026-01-21 10:05:04 INFO 見つかった: 1450
2026-01-21 10:05:05 INFO 見つからない: 50
2026-01-21 10:05:06 INFO === 処理完了 ===
```

## エラーハンドリング

### APIエラー時のリトライ

- **リトライ回数**: 最大20回
- **リトライ戦略**: 指数バックオフ + ジッター（ランダム要素）
- **待機時間**: `base_delay * (2 ^ attempt) + random(0, 1)` 秒

### よくあるエラーと対処法

#### エラー1: `my_secrets.jsonファイルが見つかりません`

**原因**: `my_secrets.json` ファイルが存在しない

**対処法**: プロジェクトルートに `my_secrets.json` を作成

#### エラー2: `シートID XXX が見つかりません`

**原因**: 指定したシートIDが存在しない

**対処法**: スプレッドシートのURLから正しいシートIDを確認

#### エラー3: `スプレッドシート読み込みエラー`

**原因**: スプレッドシートへのアクセス権限がない、またはIDが間違っている

**対処法**:
- スプレッドシートのアクセス権限を確認
- スプレッドシートIDが正しいか確認

## トラブルシューティング

### 認証エラーが発生する場合

1. `token.json` を削除して再認証を試す
2. `my_secrets.json` の認証情報が正しいか確認

### フォルダが見つからない場合

- 基準フォルダID が正しいか確認
- フォルダ構造が想定しているパターンに一致しているか確認
- ログファイルで「登録」されたフォルダ一覧を確認

### 書き込みができない場合

- スプレッドシートへの書き込み権限があるか確認
- シートIDが正しいか確認
- 列指定が正しいか確認（例: C, AA）

## 注意事項

1. **認証**: 初回実行時はブラウザで認証が必要
2. **API制限**: Google Sheets APIには1日あたりの利用制限があるため、大量のデータを処理する場合は注意
3. **上書き**: 既存のデータは上書きされます
4. **シートID**: シート名ではなく、シートID（数値）を指定してください
5. **列の指定**: A, B, C, ... Z, AA, AB, ... のようなアルファベットで指定してください

## 関連ファイル

- [copy_2026_folder.py](copy_2026_folder.py): フォルダコピースクリプト（参考実装）
- [check_normalized_csv.py](check_normalized_csv.py): CSV検証スクリプト
- [my_secrets.json](my_secrets.json): 認証情報ファイル（要作成）

## ライセンス

このスクリプトは、TeamMiraiプロジェクトの一部です。

## 更新履歴

- **2026-01-21 (v1.0)**: 初版作成
  - スプレッドシート読み込み機能
  - フォルダ構造探索機能（3パターン対応）
  - フォルダIDの自動書き込み
  - 詳細ログ出力
  - 進捗表示機能
